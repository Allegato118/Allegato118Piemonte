<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servizi 118 - Tirocinio Pratico</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2Vydml2aSAxMTggLSBUaXJvY2luaW8gUHJhdGljbyIsInNob3J0X25hbWUiOiJTZXJ2aXppIDExOCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjMDA3YmZmIiwiaWNvbnMiOltdfQ==">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: white;
            color: #666;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: #007bff;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .col {
            flex: 1;
        }
        
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .team-member {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 20px;
            display: inline-block;
            margin: 2px;
            font-size: 14px;
        }
        
        .team-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            background: white;
        }
        
        .record {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .record h3 {
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .record-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .record-detail strong {
            color: #333;
        }

        .record-interventions {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .intervention-item {
            background: #f0f8ff;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .intervention-item span {
            font-size: 0.9em;
        }
        
        .code-builder {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .code-preview {
            background: #007bff;
            color: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-family: monospace;
            font-size: 18px;
            margin-top: 10px;
        }
        
        .pathology-search {
            position: relative;
        }
        
        .pathology-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .pathology-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .pathology-item:hover {
            background: #f8f9fa;
        }
        
        .pathology-code {
            font-weight: bold;
            color: #007bff;
        }
        
        .totale-ore {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
        }
        
        .pathology-dropdown {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            background-color: white;
        }

        .intervention-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            background-color: #fcfcfc;
        }

        .intervention-list {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #f0f0f0;
            border-radius: 5px;
            padding: 10px;
            background: white;
        }
        
        .code-copy-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .code-copy-buttons .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 14px;
            margin-top: 0; /* Override default btn margin-top */
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .row {
                flex-direction: column;
                gap: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Servizi 118 - Tirocinio Pratico</h1>
            <p>Scheda 118 - Gestione Turni e Patologie</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-tab="nuovo-servizio">Nuovo Servizio</button>
            <button class="tab" data-tab="storico">Storico</button>
            <button class="tab" data-tab="patologie">Codici Patologie</button>
        </div>

<div id="nuovo-servizio" class="tab-content active">
    <form id="servizio-form">
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label for="data">Data</label>
                    <input type="date" id="data" required>
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label for="scheda118-main">Numero Scheda 118 (Servizio Principale)</label>
                    <input type="text" id="scheda118-main" placeholder="es: 01 AS 3161 / 01" maxlength="14">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label for="dalle-ore">Dalle Ore</label>
                    <input type="text" id="dalle-ore" required placeholder="HH:MM" inputmode="numeric" pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$">
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label for="alle-ore">Alle Ore</label>
                    <input type="text" id="alle-ore" required placeholder="HH:MM" inputmode="numeric" pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$">
                </div>


        
                <div class="form-group">
                    <label for="team-select">Aggiungi Membro Team</label>
                    <select id="team-select">
                        <option value="">Seleziona persona...</option>
                        </select>
                </div>
                
                <div class="form-group">
                    <label>Team del Servizio</label>
                    <div id="team-list" class="team-list">
                        <em>Nessun membro aggiunto</em>
                    </div>
                </div>

                <div class="intervention-section">
                    <h3>Gestione Interventi</h3>
                    <p>Aggiungi uno o più interventi per questo servizio.</p>
                    <div class="code-builder">
                        <h4>Costruttore Codici Uscita/Rientro</h4>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="primo-digit">Primo Digit</label>
                                    <select id="primo-digit">
                                        <option value="">Seleziona...</option>
                                        <option value="B">B</option>
                                        <option value="V">V</option>
                                        <option value="G">G</option>
                                        <option value="R">R</option>
                                        <option value="N">N</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="patologia-select">Codice Patologia</label>
                                    <select id="patologia-select" class="pathology-dropdown">
                                        <option value="">Seleziona una patologia...</option>
                                        </select>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="luogo-digit">Codice Luogo</label>
                                    <select id="luogo-digit">
                                        <option value="">Seleziona...</option>
                                        <option value="S">S - STRADA</option>
                                        <option value="P">P - LUOGO/ESERCIZIO PUBBLICO</option>
                                        <option value="Y">Y - IMPIANTO SPORTIVO</option>
                                        <option value="K">K - CASA</option>
                                        <option value="L">L - LAVORO</option>
                                        <option value="Q">Q - SCUOLA</option>
                                        <option value="Z">Z - ALTRO LUOGO</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="code-preview" id="code-preview">Codice: _ _ _ _ _</div>
                        <div class="code-copy-buttons">
                            <button type="button" class="btn btn-secondary" onclick="copyCodeToOutput('codice-uscita')">Copia in Codice Uscita</button>
                            <button type="button" class="btn btn-secondary" onclick="copyCodeToOutput('codice-rientro')">Copia in Codice Rientro</button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="codice-uscita">Codice Uscita</label>
                                <input type="text" id="codice-uscita" placeholder="es: B0101S">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="codice-rientro">Codice Rientro</label>
                                <input type="text" id="codice-rientro" placeholder="es: B0101S">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="scheda118-intervention">Numero Scheda 118 (Intervento Specifico)</label>
                        <input type="text" id="scheda118-intervention" placeholder="es: 01 AS 3161 / 01" maxlength="14">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addIntervention()">Aggiungi Intervento</button>

                    <h4>Interventi per il Servizio attuale:</h4>
                    <div id="current-interventions-list" class="intervention-list">
                        <em>Nessun intervento aggiunto per questo servizio.</em>
                    </div>
                </div>

                <button type="submit" class="btn">Salva Servizio</button>
                <button type="button" class="btn btn-secondary" onclick="copyLastEntry()">Copia Ultimo Inserimento</button>
                <button type="button" class="btn btn-secondary" onclick="syncWithGoogleSheets()">Sincronizza con Google Sheets</button>
            </form>
        </div>
        
        <div id="storico" class="tab-content">
            <h2>Storico Servizi</h2>
            <div id="services-list">
                <p><em>Nessun servizio registrato</em></p>
            </div>
            <div class="totale-ore">
                <div>Totale Ore Svolte: <span id="total-hours">0:00</span></div>
            </div>
            <button class="btn btn-secondary" onclick="exportToJSON()">Esporta Dati JSON</button>
            <button class="btn btn-danger" onclick="clearAllData()">Cancella Tutti i Dati</button>
        </div>
        
        <div id="patologie" class="tab-content">
            <h2>Codici Patologie</h2>
            <div id="pathology-categories"></div>
        </div>
    </div>

    <script>
        // Database patologie
        const pathologies = {
            'C01 TRAUMATICA': {
                'C 01 ': 'TRAUMATICA',
                'C0101': 'Cranio',
                'C0102': 'Torace',
                'C0103': 'Addome',
                'C0104': 'Arti',
                'C0105': 'Rachide',
                'C0106': 'Emorragia',
                'C0107': 'Amputazione',
                'C0108': 'Ferita',
                'C0109': 'Frattura',
                'C0110': 'Contusione',
                'C0111': 'Ustione',
                'C0112': 'Folgorazione/elettrocuzione',
                'C0113': 'Lesione da freddo',
                'C0114': 'Lesione agli occhi',
                'C0115': 'Politraumatismo',
                'C0116': 'Altra traumatica'
            },
            'C02 CARDIOCIRCOLATORIA': {
                'C 02 ': 'CARDIOCIRCOLATORIA',
                'C0201': 'Crisi ipertensiva',
                'C0202': 'Scompenso cardio-circolatorio',
                'C0203': 'Dolore toracico',
                'C0204': 'Cardiopalmo/Aritmia',
                'C0205': 'Arresto cardio-circolatorio',
                'C0206': 'Sindrome coronarica acuta',
                'C0209': 'Altra cardio-circolatoria'
            },
            'C03 RESPIRATORIA': {
                'C 03 ': 'RESPIRATORIA',
                'C0301': 'Distress respiratorio',
                'C0302': 'Corpo estraneo',
                'C0303': 'Crisi asmatica',
                'C0304': 'Immersione/sommersione',
                'C0305': 'Insufficienza respiratoria cronica',
                'C0309': 'Altra respiratoria'
            },
            'C04 NEUROLOGICA': {
                'C 04 ': 'NEUROLOGICA',
                'C0401': 'Convulsioni',
                'C0402': 'Cefalea',
                'C0403': 'Coma',
                'C0404': 'Ictus',
                'C0405': 'Decadimento psichico',
                'C0406': 'Perdita di coscienza',
                'C0409': 'Altra neurologica'
            },
            'C05 PSICHIATRICA': {
                'C 05 ': 'PSICHIATRICA',
                'C0501': 'Tentato suicidio',
                'C0502': 'Agitazione psicomotoria',
                'C0509': 'Altra psichiatrica'
            },
            'C06 NEOPLASTICA': {
                'C 06 ': 'NEOPLASTICA',
                'C0601': 'Neoplastica'
            },
            'C07 TOSSICOLOGICA': {
                'C 07 ': 'TOSSICOLOGICA',
                'C0700': 'Intossicazione etilica',
                'C0701': 'Ossido di carbonio',
                'C0702': 'Farmaci',
                'C0703': 'Alimenti',
                'C0704': 'sostanze chimiche',
                'C0705': 'overdose/stupefacenti',
                'C0709': 'altra intossicazione'
            },
            'C08 METABOLICA': {
                'C 08 ': 'METABOLICA',
                'C0801': 'Iperglicemia',
                'C0802': 'Ipoglicemia',
                'C0809': 'Altro – metabolica'
            },
            'C09 GASTROENTEROLOGICA': {
                'C 09 ': 'GASTROENTEROLOGICA',
                'C0901': 'Emorragia digestiva',
                'C0902': 'Dolore addominale',
                'C0909': 'Altro – gastroenterologica'
            },
            'C10 UROLOGICA': {
                'C 10 ': 'UROLOGICA',
                'C1001': 'Colica renale',
                'C1002': 'Ritenzione urinaria',
                'C1009': 'Altro - urologica'
            },
            'C11 OCULISTICA': {
                'C 11 ': 'OCULISTICA',
                'C1101': 'Ferita penetrante occhio',
                'C1109': 'Altro – oftalmologia'
            },
            'C12 OTORINOLARINGOIATRICA': {
                'C 12 ': 'OTORINOLARINGOIATRICA',
                'C1201': 'Epistassi',
                'C1202': 'Corpo estraneo',
                'C1209': 'Altro – ORL'
            },
            'C13 DERMATOLOGICA': {
                'C 13 ': 'DERMATOLOGICA',
                'C1301': 'Parassitosi',
                'C1302': 'Reazione orticaloide',
                'C1309': 'Altro – dermatologica'
            },
            'C14 OSTETRICO-GINECOLOGICA': {
                'C 14 ': 'OSTETRICO-GINECOLOGICA',
                'C1401': 'Parto',
                'C1402': 'Metrorragia',
                'C1403': 'Minaccia aborto',
                'C1409': 'Altro - ostetrico-ginecologica'
            },
            'C15 INFETTIVA': {
                'C 15 ': 'INFETTIVA',
                'C1501': 'Stato febbrile',
                'C1509': 'Altro – infettiva'
            },
            'C19 ALTRA PATOLOGIA': {
                'C 19 ': 'ALTRA PATOLOGIA',
                'C1901': 'Stato febbrile',
                'C1902': 'NBCR (catastrofe o emergenza nucleare, batteriologica, chimica o radioattiva)',
                'C1909': 'Altra patologia'
            },
            'C20 PATOLOGIA NON IDENTIFICATA': {
                'C 20 ': 'PATOLOGIA NON IDENTIFICATA',
                'C2001': 'Patologia non identificata'
            }
        };

        // Stato dell'applicazione
        let services = JSON.parse(localStorage.getItem('services') || '[]');
        let allTeamMembers = JSON.parse(localStorage.getItem('allTeamMembers') || '["Marina PISTONO", "Irina RONTU", "Simone VENUTI", "Svetlana RACHIERU", "Marco GALLO BALMA", "Gaetano TRAVESSA", "Giovanni \'Ivan\' NICCOLI", "Maria Antonietta \'Antonella\' CAPOBIANCO", "Gabriele GIRLEANU", "Franco VIOLA", "Riccardo VIOLA", "Muhammadu HIBALLOW", "Carolina Mercedes MUIJCA Monroy"]');
        let currentServiceTeam = [];
        let currentInterventions = []; // New array to hold interventions for the current service being created
        let selectedPathologyCode = '';
        let googleSheetsConfigured = localStorage.getItem('googleSheetsConfigured') === 'true';

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadPathologies();
            updateServicesDisplay();
            updateTotalHours();
            loadPathologyDropdown();
            setupTabNavigation();
            populateTeamMembersDropdown();
            
            // Imposta data odierna
            document.getElementById('data').valueAsDate = new Date();
            
            // Aggiorna anteprima codice
            updateCodePreview();
            
            // Event listeners per codice builder
            document.getElementById('primo-digit').addEventListener('change', updateCodePreview);
            document.getElementById('luogo-digit').addEventListener('change', updateCodePreview);
            document.getElementById('patologia-select').addEventListener('change', function() {
                const value = this.value;
                if (value) {
                    // Prende solo la parte numerica del codice patologia (es. "0101" da "C0101")
                    selectedPathologyCode = value.substring(1); 
                    updateCodePreview();
                } else {
                    selectedPathologyCode = '';
                    updateCodePreview();
                }
            });
            
            // Event listener per aggiunta team member
            document.getElementById('team-select').addEventListener('change', addTeamMemberToCurrentService);

            // Event listener per copiare Numero Scheda 118 (Servizio Principale) in (Intervento Specifico)
            document.getElementById('scheda118-main').addEventListener('input', function() {
                document.getElementById('scheda118-intervention').value = this.value;
            });

            // Set minutes to multiples of 15 for time inputs
            setMinuteStepForTimeInputs();
        });

        // Configurazione navigazione a schede
        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });
        }

        // Gestione tab
        function showTab(tabName) {
            // Rimuovi classe active da tutti i tab e contenuti
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Aggiungi classe active al tab e contenuto selezionato
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Function to set the minute step for time inputs
        function setMinuteStepForTimeInputs() {
            const dalleOreInput = document.getElementById('dalle-ore');
            const alleOreInput = document.getElementById('alle-ore');

            dalleOreInput.addEventListener('change', function() {
                const value = dalleOreInput.value;
                if (value) {
                    const [hours, minutes] = value.split(':').map(Number);
                    const roundedMinutes = Math.round(minutes / 15) * 15;
                    const newMinutes = roundedMinutes % 60;
                    const newHours = hours + Math.floor(roundedMinutes / 60);
                    dalleOreInput.value = `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
                }
            });

            alleOreInput.addEventListener('change', function() {
                const value = alleOreInput.value;
                if (value) {
                    const [hours, minutes] = value.split(':').map(Number);
                    const roundedMinutes = Math.round(minutes / 15) * 15;
                    const newMinutes = roundedMinutes % 60;
                    const newHours = hours + Math.floor(roundedMinutes / 60);
                    alleOreInput.value = `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
                }
            });
        }

        // Carica dropdown patologie
        function loadPathologyDropdown() {
            const select = document.getElementById('patologia-select');
            select.innerHTML = '<option value="">Seleziona una patologia...</option>'; // Clear existing options
            
            Object.entries(pathologies).forEach(([category, codes]) => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                
                Object.entries(codes).forEach(([code, desc]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = `${code} - ${desc}`;
                    optgroup.appendChild(option);
                });
                
                select.appendChild(optgroup);
            });
        }

        // Carica database patologie per visualizzazione
        function loadPathologies() {
            const container = document.getElementById('pathology-categories');
            container.innerHTML = '';
            
            Object.entries(pathologies).forEach(([category, codes]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `
                    <h3 style="color: #007bff; margin: 20px 0 10px 0;">${category}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 5px;">
                        ${Object.entries(codes).map(([code, desc]) => 
                            `<div style="font-size: 14px; padding: 5px;"><strong>${code}</strong> ${desc}</div>`
                        ).join('')}
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
        }

        // Aggiorna anteprima codice
        function updateCodePreview() {
            const primo = document.getElementById('primo-digit').value;
            const patologia = selectedPathologyCode; // Questo è già solo la parte numerica
            const luogo = document.getElementById('luogo-digit').value;
            
            let preview = 'Codice: ';
            let pathologyDisplay = patologia;

            // Se la patologia è solo due cifre (es. "01" da C01), aggiungi uno spazio
            if (patologia.length === 2) {
                pathologyDisplay = patologia + ' ';
            } else if (patologia.length === 4) { // Se è di 4 cifre (es. "0101") aggiungi uno spazio prima
                 pathologyDisplay = ' ' + patologia;
            }


            preview += primo || '_';
            preview += (patologia ? ' ' : '_'); // Aggiungi uno spazio se la patologia è selezionata, altrimenti un underscore
            preview += pathologyDisplay || '___';
            preview += (luogo ? ' ' : '_'); // Aggiungi uno spazio se il luogo è selezionato, altrimenti un underscore
            preview += luogo || '_';
            
            document.getElementById('code-preview').textContent = preview;
        }

        // Funzione per copiare il codice preview nel campo desiderato
        function copyCodeToOutput(targetId) {
            const codePreviewText = document.getElementById('code-preview').textContent;
            let codeToCopy = codePreviewText.replace('Codice: ', '').replace(/_/g, '').trim(); 
            
            // Rimuove gli spazi extra e formatta per la copia
            // Es: "B 01 S" diventa "B01S"
            // Es: "B 0101 S" diventa "B0101S"
            codeToCopy = codeToCopy.replace(/\s+/g, '');

            if (codeToCopy.length < 3) { // Un codice minimo è composto da Primo Digit + Patologia (es. "B01") o Primo Digit + Luogo (es. "BS")
                alert('Costruisci prima un codice completo.');
                return;
            }
            
            document.getElementById(targetId).value = codeToCopy;
        }

        // Add an intervention
        function addIntervention() {
            const codiceUscita = document.getElementById('codice-uscita').value.trim();
            const codiceRientro = document.getElementById('codice-rientro').value.trim();
            const scheda118Intervention = document.getElementById('scheda118-intervention').value.trim();

            // L'intervento può essere aggiunto anche se i campi sono vuoti, purché almeno uno sia compilato
            if (!codiceUscita && !codiceRientro && !scheda118Intervention) {
                alert('Compila almeno uno dei campi: Codice Uscita, Codice Rientro o Numero Scheda 118 per l\'intervento.');
                return;
            }

            const interventionString = 
                `${codiceUscita || 'N/D'} / ${codiceRientro || 'N/D'} / ${scheda118Intervention || 'N/D'}`;
            
            currentInterventions.push({
                codiceUscita: codiceUscita,
                codiceRientro: codiceRientro,
                scheda118: scheda118Intervention,
                interventionString: interventionString
            });

            updateCurrentInterventionsDisplay();

            // Clear intervention fields after adding
            document.getElementById('codice-uscita').value = '';
            document.getElementById('codice-rientro').value = '';
            document.getElementById('scheda118-intervention').value = '';
            document.getElementById('primo-digit').value = '';
            document.getElementById('patologia-select').value = '';
            document.getElementById('luogo-digit').value = '';
            selectedPathologyCode = '';
            updateCodePreview();
        }

        // Update display of interventions for the current service being created
        function updateCurrentInterventionsDisplay() {
            const container = document.getElementById('current-interventions-list');
            if (currentInterventions.length === 0) {
                container.innerHTML = '<em>Nessun intervento aggiunto per questo servizio.</em>';
                return;
            }
            
            container.innerHTML = currentInterventions.map((intervention, index) => `
                <div class="intervention-item">
                    <span>${intervention.interventionString}</span>
                    <button onclick="removeIntervention(${index})" style="border:none; background:none; color:red; cursor:pointer;">×</button>
                </div>
            `).join('');
        }

        // Remove an intervention from the current service being created
        function removeIntervention(index) {
            currentInterventions.splice(index, 1);
            updateCurrentInterventionsDisplay();
        }

        // Populate team members dropdown from allTeamMembers array
        function populateTeamMembersDropdown() {
            const select = document.getElementById('team-select');
            select.innerHTML = '<option value="">Seleziona persona...</option>'; // Clear existing options
            allTeamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                select.appendChild(option);
            });
            // Add the "Nuovo Collega" option at the end
            const newColleagueOption = document.createElement('option');
            newColleagueOption.value = 'Nuovo Collega';
            newColleagueOption.textContent = '+ Aggiungi Nuovo Collega';
            select.appendChild(newColleagueOption);
        }

        // Gestione team for current service
        function addTeamMemberToCurrentService() {
            const select = document.getElementById('team-select');
            const value = select.value;
            
            if (!value) return;
            
            if (value === 'Nuovo Collega') {
                const nome = prompt('Inserisci nome del nuovo collega:');
                if (nome && nome.trim()) {
                    const trimmedName = nome.trim();
                    if (!allTeamMembers.includes(trimmedName)) {
                        allTeamMembers.push(trimmedName);
                        localStorage.setItem('allTeamMembers', JSON.stringify(allTeamMembers));
                        populateTeamMembersDropdown(); // Re-populate to include the new member
                    }
                    if (!currentServiceTeam.includes(trimmedName)) {
                        currentServiceTeam.push(trimmedName);
                    }
                }
            } else {
                if (!currentServiceTeam.includes(value)) {
                    currentServiceTeam.push(value);
                }
            }
            
            select.value = '';
            updateCurrentServiceTeamDisplay();
        }

        function updateCurrentServiceTeamDisplay() {
            const container = document.getElementById('team-list');
            if (currentServiceTeam.length === 0) {
                container.innerHTML = '<em>Nessun membro aggiunto</em>';
                return;
            }
            
            container.innerHTML = currentServiceTeam.map(member => 
                `<span class="team-member">${member} <button onclick="removeTeamMemberFromCurrentService('${member}')" style="border:none; background:none; color:red; cursor:pointer;">×</button></span>`
            ).join('');
        }

        function removeTeamMemberFromCurrentService(member) {
            currentServiceTeam = currentServiceTeam.filter(m => m !== member);
            updateCurrentServiceTeamDisplay();
        }

        // Gestione form submission
        document.getElementById('servizio-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const data = document.getElementById('data').value;
            const dalleOre = document.getElementById('dalle-ore').value;
            const alleOre = document.getElementById('alle-ore').value;
            const scheda118Main = document.getElementById('scheda118-main').value;
            
            if (!data || !dalleOre || !alleOre) {
                alert('Compila tutti i campi obbligatori: Data, Dalle Ore, Alle Ore.');
                return;
            }

            if (currentInterventions.length === 0) {
                alert('Aggiungi almeno un intervento per questo servizio.');
                return;
            }
            
            // Calcola ore totali
            const start = new Date(`1970-01-01T${dalleOre}:00`);
            const end = new Date(`1970-01-01T${alleOre}:00`);
            let diff = end - start;
            
            // Gestisce il passaggio di mezzanotte
            if (diff < 0) {
                diff += 24 * 60 * 60 * 1000;
            }
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const totaleOre = `${hours}:${minutes.toString().padStart(2, '0')}`;
            
            const service = {
                id: Date.now(),
                data,
                dalleOre,
                alleOre,
                totaleOre,
                scheda118Main, // Main service 118 card number
                team: [...currentServiceTeam],
                interventions: [...currentInterventions], // Store all interventions
                timestamp: new Date().toISOString(),
                synced: false
            };
            
            services.push(service);
            localStorage.setItem('services', JSON.stringify(services));
            
            // Reset form
            this.reset();
            currentServiceTeam = [];
            currentInterventions = [];
            selectedPathologyCode = '';
            document.getElementById('data').valueAsDate = new Date();
            document.getElementById('patologia-select').value = '';
            updateCurrentServiceTeamDisplay();
            updateCurrentInterventionsDisplay();
            updateCodePreview();
            
            updateServicesDisplay();
            updateTotalHours();
            
            alert('Servizio salvato con successo!');
            
            // Sincronizza con Google Sheets se configurato
            if (googleSheetsConfigured) {
                syncWithGoogleSheets();
            }
        });

        // Copia ultimo inserimento
        function copyLastEntry() {
            if (services.length === 0) {
                alert('Nessun servizio precedente da copiare');
                return;
            }
            
            const last = services[services.length - 1];
            
            // Copy main service fields, keep current date
            document.getElementById('dalle-ore').value = last.dalleOre;
            document.getElementById('alle-ore').value = last.alleOre;
            document.getElementById('scheda118-main').value = last.scheda118Main || '';
            
            // Copy team
            currentServiceTeam = [...last.team];
            updateCurrentServiceTeamDisplay();

            // Copy interventions
            currentInterventions = [...last.interventions];
            updateCurrentInterventionsDisplay();

            // If there's at least one intervention, pre-fill the intervention builder with the last one
            if (last.interventions && last.interventions.length > 0) {
                populateInterventionFields(last.interventions[last.interventions.length - 1]);
            } else {
                // Clear intervention builder fields if no interventions in last service
                document.getElementById('codice-uscita').value = '';
                document.getElementById('codice-rientro').value = '';
                document.getElementById('scheda118-intervention').value = '';
                document.getElementById('primo-digit').value = '';
                document.getElementById('patologia-select').value = '';
                document.getElementById('luogo-digit').value = '';
                selectedPathologyCode = '';
                updateCodePreview();
            }
            
            alert('Campi copiati dall\'ultimo servizio. Verifica i dati e modifica se necessario.');
        }

        // Aggiorna visualizzazione storico
        function updateServicesDisplay() {
            const container = document.getElementById('services-list');
            
            if (services.length === 0) {
                container.innerHTML = '<p><em>Nessun servizio registrato</em></p>';
                return;
            }
            
            container.innerHTML = services.map(service => `
                <div class="record">
                    <h3>${service.data} - ${service.totaleOre} ore</h3>
                    <div class="record-detail">
                        <span><strong>Orario:</strong> ${service.dalleOre} - ${service.alleOre}</span>
                        <span><strong>Scheda 118 Principale:</strong> ${service.scheda118Main || 'N/D'}</span>
                    </div>
                    <div>
                        <strong>Team:</strong> ${service.team.join(', ')}
                    </div>
                    <div class="record-interventions">
                        <strong>Interventi:</strong>
                        ${service.interventions.length > 0 ? 
                            service.interventions.map(int => `<div class="intervention-item-static">${int.interventionString}</div>`).join('')
                            : 'Nessun intervento registrato.'
                        }
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        ${new Date(service.timestamp).toLocaleString()} 
                        ${service.synced ? '✅ Sincronizzato' : '⚠️ Da sincronizzare'}
                    </div>
                    <button onclick="deleteService(${service.id})" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Elimina</button>
                </div>
            `).join('');
        }

        // Aggiorna totale ore
        function updateTotalHours() {
            let totalMinutes = 0;
            
            services.forEach(service => {
                const [hours, minutes] = service.totaleOre.split(':').map(Number);
                totalMinutes += hours * 60 + minutes;
            });
            
            const totalHours = Math.floor(totalMinutes / 60);
            const remainingMinutes = totalMinutes % 60;
            
            document.getElementById('total-hours').textContent = 
                `${totalHours}:${remainingMinutes.toString().padStart(2, '0')}`;
        }

        // Elimina servizio
        function deleteService(id) {
            if (confirm('Sei sicuro di voler eliminare questo servizio?')) {
                services = services.filter(service => service.id !== id);
                localStorage.setItem('services', JSON.stringify(services));
                updateServicesDisplay();
                updateTotalHours();
            }
        }

        // Esporta dati
        function exportToJSON() {
            const dataStr = JSON.stringify(services, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `servizi-118-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Cancella tutti i dati
        function clearAllData() {
            if (confirm('Sei sicuro di voler cancellare TUTTI i dati? Questa azione non può essere annullata.')) {
                services = [];
                localStorage.removeItem('services');
                localStorage.removeItem('allTeamMembers'); // Clear stored team members too
                allTeamMembers = ["Marina PISTONO", "Irina RONTU", "Simone VENUTI", "Svettava RACCHINI", "Marco GALLO BALMA", "Gaetano TRAVESSA", "Giovanni 'Ivan' NICCOLI", "Maria Antonietta 'Antonella' CAPOBIANCO", "Gabriele GIRLEANU", "Franco VIOLA", "Riccardo VIOLA", "Muhammadu HIBALLOW", "Carolina Mercedes MUIJCA Monroy"]; // Reset to default
                populateTeamMembersDropdown();
                updateServicesDisplay();
                updateTotalHours();
                alert('Tutti i dati sono stati cancellati.');
            }
        }

        // Sincronizzazione con Google Sheets (Placeholder - requires external Google Apps Script)
        function syncWithGoogleSheets() {
            if (!googleSheetsConfigured) {
                configureGoogleSheets();
                return;
            }
            
            const scriptId = localStorage.getItem('googleScriptId');
            if (!scriptId) {
                alert('ID dello script Google Apps non configurato. Si prega di configurarlo.');
                configureGoogleSheets();
                return;
            }

            const unsyncedServices = services.filter(service => !service.synced);
            
            if (unsyncedServices.length === 0) {
                alert('Nessun servizio da sincronizzare');
                return;
            }
            
            alert(`Tentativo di sincronizzazione di ${unsyncedServices.length} servizi con Google Sheets...`);
            
            // This is where you would make the actual call to your Google Apps Script
            // Example: google.script.run.withSuccessHandler(onSheetSuccess).withFailureHandler(onSheetFailure).addServices(unsyncedServices);
            
            // For demonstration purposes, simulate success after a delay
            setTimeout(() => {
                services.forEach(service => service.synced = true);
                localStorage.setItem('services', JSON.stringify(services));
                updateServicesDisplay();
                alert('Sincronizzazione completata con successo! (Simulato)');
            }, 2000);
        }

        function configureGoogleSheets() {
            const scriptId = prompt('Inserisci l\'ID dello script Google Apps (necessario per la sincronizzazione):');
            if (scriptId && scriptId.trim()) {
                localStorage.setItem('googleScriptId', scriptId.trim());
                localStorage.setItem('googleSheetsConfigured', 'true');
                googleSheetsConfigured = true;
                alert('Configurazione Google Sheets completata. Ora puoi sincronizzare i dati.');
            } else {
                alert('ID dello script non valido. La sincronizzazione non sarà disponibile.');
                localStorage.removeItem('googleScriptId');
                localStorage.removeItem('googleSheetsConfigured');
                googleSheetsConfigured = false;
            }
        }

        function loadFromGoogleSheets() {
            // Placeholder for loading data from Google Sheets
            // In a real application, you would call your Google Apps Script here
            // Example: google.script.run.withSuccessHandler(onLoadSheetSuccess).withFailureHandler(onLoadSheetFailure).getServices();
            alert('Caricamento dati da Google Sheets non implementato in questa versione standalone. I dati sono salvati localmente.');
        }

        // Helper for Google Apps Script success/failure (conceptual, not functional in standalone HTML)
        function onSheetSuccess(response) {
            console.log('Google Sheets Sync Success:', response);
            // Mark services as synced and update display
            services.forEach(service => service.synced = true);
            localStorage.setItem('services', JSON.stringify(services));
            updateServicesDisplay();
            alert('Sincronizzazione completata con successo!');
        }

        function onSheetFailure(error) {
            console.error('Google Sheets Sync Error:', error);
            alert('Errore durante la sincronizzazione con Google Sheets. Controlla la console per i dettagli o il tuo ID script.');
        }

        // For "Copia Ultimo Inserimento" to populate the intervention fields
        function populateInterventionFields(intervention) {
            document.getElementById('codice-uscita').value = intervention.codiceUscita || '';
            document.getElementById('codice-rientro').value = intervention.codiceRientro || '';
            document.getElementById('scheda118-intervention').value = intervention.scheda118 || '';

            // Improved logic to populate the code builder from an existing code
            let codeToParse = intervention.codiceUscita || intervention.codiceRientro;
            if (codeToParse) {
                // Assuming the format is [PRIMO_DIGIT][PATHOLOGY_CODE_PART][LUOGO_DIGIT]
                // Example: B0101S or B01S
                const primoDigit = codeToParse[0];
                let pathologyCodePart = '';
                let luogoDigit = '';

                // Try to extract pathology and luogo
                if (codeToParse.length >= 2) { // At least Primo + X or Primo + XX
                    // If it's a 2-digit pathology (e.g., C01), it will be 3 characters long (B01)
                    // If it's a 4-digit pathology (e.g., C0101), it will be 5 characters long (B0101)
                    // If it's just a luogo, it will be 2 characters long (BS)

                    // Simple approach: Assume anything after the first char and before the last char is pathology, if numeric
                    const middlePart = codeToParse.substring(1, codeToParse.length - 1);
                    if (!isNaN(middlePart) && middlePart !== '') { // Check if it's numeric
                        pathologyCodePart = 'C' + middlePart; // Re-add 'C' for dropdown matching
                    }
                    luogoDigit = codeToParse[codeToParse.length - 1];

                     // Edge case: if code is only 2 characters, like "BS", then middlePart is empty
                    if (codeToParse.length === 2 && isNaN(codeToParse[1])) { // e.g., "BS"
                        pathologyCodePart = '';
                        luogoDigit = codeToParse[1];
                    } else if (codeToParse.length === 3 && !isNaN(codeToParse.substring(1,3))) { // e.g., "B01", no luogo
                        pathologyCodePart = 'C' + codeToParse.substring(1,3);
                        luogoDigit = '';
                    } else if (codeToParse.length === 6 && !isNaN(codeToParse.substring(1,5))) { // e.g., "B0101S"
                        pathologyCodePart = 'C' + codeToParse.substring(1,5);
                        luogoDigit = codeToParse[5];
                    }
                }

                document.getElementById('primo-digit').value = primoDigit;
                
                const pathologySelect = document.getElementById('patologia-select');
                pathologySelect.value = pathologyCodePart;
                selectedPathologyCode = pathologyCodePart.substring(1); // Set for preview logic
                
                document.getElementById('luogo-digit').value = luogoDigit;
                updateCodePreview();
            } else {
                document.getElementById('primo-digit').value = '';
                document.getElementById('patologia-select').value = '';
                document.getElementById('luogo-digit').value = '';
                selectedPathologyCode = '';
                updateCodePreview();
            }
        }
    </script>
</body>
</html>
